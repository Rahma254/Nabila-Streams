<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Nabila Streams 🎵</title>
  <script type="module">
    import { supabase } from './supabase.js';
    const session = await supabase.auth.getSession();
    if (!session.data.session) window.location.href = 'login.html';
  </script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tailwindcss/postcss7-compat@2.2.17/dist/tailwind.min.css">
</head>
<body class="bg-gray-100 text-gray-800 font-sans">

  <!-- Header -->
  <div class="text-center py-6">
    <h1 class="text-4xl font-bold">Nabila Streams 🎵</h1>
    <p class="text-gray-600">Lagu-lagu ciptaan original kamu - streaming sekarang!</p>
    <button id="logoutBtn" class="absolute top-4 right-4 bg-red-600 text-white px-4 py-2 rounded">Logout</button>
  </div>

  <!-- Video Player -->
  <div id="player-container" class="max-w-xl mx-auto bg-white rounded-xl shadow p-4">
    <video id="video-player" class="w-full rounded" controls autoplay></video>
    <h2 id="song-title" class="text-xl font-semibold text-center mt-4">🎵 Judul Lagu</h2>

    <div class="flex justify-center gap-4 mt-4 flex-wrap">
      <button id="prevBtn" class="bg-green-600 text-white px-4 py-2 rounded">⏮ Sebelumnya</button>
      <button id="nextBtn" class="bg-green-600 text-white px-4 py-2 rounded">Selanjutnya ⏭</button>
      <button id="likeBtn" class="bg-red-500 text-white px-4 py-2 rounded">❤️ Like (0)</button>
      <button id="shareBtn" class="bg-green-500 text-white px-4 py-2 rounded">🔗 Share</button>
    </div>

    <!-- Komentar -->
    <div class="mt-6">
      <h3 class="text-lg font-bold mb-2">Komentar</h3>
      <ul id="comment-list" class="list-disc pl-5 space-y-1"></ul>

      <form id="comment-form" class="mt-4 flex gap-2">
        <input id="comment-input" type="text" placeholder="Tulis komentar..." class="flex-grow border px-3 py-2 rounded"/>
        <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded">Kirim</button>
      </form>
    </div>
  </div>

  <!-- Script Player -->
  <script type="module">
    import { supabase } from './supabase.js';

    const videoPlayer = document.getElementById("video-player");
    const songTitle = document.getElementById("song-title");
    const likeBtn = document.getElementById("likeBtn");
    const shareBtn = document.getElementById("shareBtn");
    const commentList = document.getElementById("comment-list");
    const commentForm = document.getElementById("comment-form");
    const commentInput = document.getElementById("comment-input");
    const logoutBtn = document.getElementById("logoutBtn");

    // Playback IDs (MUX)
    const songs = [
      { title: "Janda Nakal", id: "1QLzDAFFm01uW02VxAf2yZ004SlFtcOLTw3L7s5woOrl5Q" },
      { title: "Drunk Confessions", id: "d802AEWpBCRJ9dPJVhQFinHhkH01hRb027NssU1FykBgYg" },
      { title: "Broken Home Anthem", id: "kqp9FRoagl00tTEk5ZSdlIYAfpBWgbjvGLmf2sFl9bGY" },
      { title: "Pelukan Senja", id: "y02TWzsfRTj717WZty00AY028A97xe01l501aAAJjiXAjL7A" }
    ];
    let currentSong = 0;

    function loadSong(index) {
      const song = songs[index];
      videoPlayer.src = `https://stream.mux.com/${song.id}.m3u8`;
      songTitle.textContent = `🎵 ${song.title}`;
      loadComments(song.title);
      updateLikes(song.title);
    }

    document.getElementById("prevBtn").onclick = () => {
      currentSong = (currentSong - 1 + songs.length) % songs.length;
      loadSong(currentSong);
    };

    document.getElementById("nextBtn").onclick = () => {
      currentSong = (currentSong + 1) % songs.length;
      loadSong(currentSong);
    };

    async function loadComments(song) {
      commentList.innerHTML = "";
      const { data } = await supabase.from("comment").select("*").eq("song_title", song).order("created_at", { ascending: false });
      data.forEach(item => {
        const li = document.createElement("li");
        li.textContent = item.content;
        commentList.appendChild(li);
      });
    }

    commentForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const content = commentInput.value;
      const title = songs[currentSong].title;
      await supabase.from("comment").insert({ song_title: title, content });
      commentInput.value = "";
      loadComments(title);
    });

    async function updateLikes(song) {
      const { data, count } = await supabase
        .from("song_analytics")
        .select("id", { count: "exact" })
        .eq("song_title", song);
      likeBtn.textContent = `❤️ Like (${count})`;
    }

    likeBtn.addEventListener("click", async () => {
      const title = songs[currentSong].title;
      await supabase.from("song_analytics").insert({ song_title: title });
      updateLikes(title);
    });

    shareBtn.onclick = () => {
      const url = `${window.location.href}?song=${currentSong}`;
      navigator.clipboard.writeText(url);
      alert("Link disalin!");
    };

    logoutBtn.addEventListener("click", async () => {
      await supabase.auth.signOut();
      window.location.href = 'login.html';
    });

    loadSong(currentSong);
  </script>
</body>
</html>
